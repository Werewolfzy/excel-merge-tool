<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ–‡ä»¶åˆå¹¶å·¥å…·</title>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <!-- Handsontable for spreadsheet UI (optional, with fallback) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #3498db, #2c3e50);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 26px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 14px;
            opacity: 0.85;
            margin-top: 5px;
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn i {
            font-size: 16px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .file-list {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            min-height: 120px;
            max-height: 180px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 12px;
        }
        
        .file-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f1f8ff;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .file-item .name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        .file-item .remove {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            padding: 0 8px;
            border-radius: 4px;
        }
        
        .file-item .remove:hover {
            background: #fadbd8;
        }
        
        .file-item .config-btn {
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            padding: 0 8px;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .file-item .config-btn:hover {
            background: #e3f2fd;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #7f8c8d;
            padding: 5px 2px;
        }
        
        .output-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .output-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            height: 200px;
            overflow-y: auto;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .log-entry {
            margin: 4px 0;
            line-height: 1.4;
        }
        
        .log-info { color: #3498db; }
        .log-success { color: #2ecc71; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        
        .progress-container {
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .action-area {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 12px 20px;
            border-top: 1px solid #e9ecef;
            font-size: 14px;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready { background: #2ecc71; }
        .status-working { background: #f39c12; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
            color: #3498db;
            font-weight: bold;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #2c3e50;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .highlight {
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* æ¨¡å¼é€‰æ‹© */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .mode-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }
        
        .mode-option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .mode-option.active {
            border-color: #3498db;
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .mode-option .mode-title {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .mode-option .mode-desc {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        /* æ‰‹åŠ¨é…ç½®åŒºåŸŸ */
        .manual-config-section {
            display: none;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .manual-config-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .group-config {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .group-name-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        
        .selection-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .handsontable-container {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .selection-status {
            font-size: 13px;
            color: #666;
            padding: 5px 0;
        }
        
        .file-config-status {
            font-size: 12px;
            color: #2ecc71;
            margin-left: 8px;
            font-weight: 600;
        }
        
        .file-config-status.pending {
            color: #f39c12;
        }
        
        .manual-merge-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .manual-merge-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .group-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .group-tag {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .group-tag .count {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .merge-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            font-family: 'Consolas', monospace;
        }
        
        /* é€‰åŒºé«˜äº® */
        .selection-highlight {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }

        /* é…ç½®ç»„åˆ—è¡¨ */
        .config-group-item {
            background: #e3f2fd;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-group-item .group-info {
            flex: 1;
        }
        
        .config-group-item .group-actions {
            display: flex;
            gap: 5px;
        }
        
        .config-group-item button {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }

        /* ç»„åè¾“å…¥å®¹å™¨ */
        .group-name-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .group-name-container input,
        .group-name-container select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .group-name-container select {
            flex: 1;
            min-width: 150px;
        }
        
        .group-name-container input[type="text"] {
            flex: 1;
            min-width: 150px;
        }
        
        .group-name-container .new-group-toggle {
            font-size: 12px;
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            white-space: nowrap;
        }
        
        .group-name-container .new-group-toggle:hover {
            color: #2980b9;
        }

        /* éƒ¨åˆ†é…ç½®æç¤º */
        .partial-config-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            color: #856404;
        }

        /* åˆ†ç»„ä¸‹è½½åŒºåŸŸ */
        .group-download-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .group-download-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .group-download-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .group-download-info {
            flex: 1;
        }
        
        .group-download-info .group-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .group-download-info .group-stats {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .group-download-actions {
            display: flex;
            gap: 8px;
        }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #95a5a6;
            font-size: 14px;
        }

        /* é€‰æ‹©èŒƒå›´æç¤º */
        .selection-range-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 13px;
            font-weight: 600;
        }

        /* é€‰æ‹©æ¨¡å¼æŒ‡ç¤ºå™¨ */
        .selection-mode-indicator {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-left: 10px;
        }

        /* æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼ˆHandsontableå¤‡ç”¨ï¼‰ */
        .manual-input-mode {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        
        .manual-input-mode.active {
            display: block;
        }
        
        .manual-input-group {
            margin-bottom: 12px;
        }
        
        .manual-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .manual-input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .manual-input-group .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        /* Handsontableé”™è¯¯æç¤º */
        .handsontable-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }

        .handsontable-error .retry-btn {
            margin-top: 8px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .handsontable-error .retry-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .action-area {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .output-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .mode-selector {
                flex-direction: column;
            }
            
            .selection-controls {
                flex-direction: column;
            }
            
            .group-name-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .group-download-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .group-download-actions {
                width: 100%;
            }
            
            .group-download-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Excelæ–‡ä»¶åˆå¹¶å·¥å…·</h1>
            <div class="subtitle">åœ¨æµè§ˆå™¨ä¸­å®‰å…¨åœ°åˆå¹¶å¤šä¸ªExcelæ–‡ä»¶</div>
        </div>
        
        <div class="content">
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="section">
                <div class="section-title">
                    <span>âš™ï¸</span> é€‰æ‹©å·¥ä½œæ¨¡å¼
                </div>
                <div class="mode-selector">
                    <div class="mode-option active" data-mode="auto">
                        <div class="mode-title">ğŸš€ è‡ªåŠ¨æ¨¡å¼</div>
                        <div class="mode-desc">æ™ºèƒ½è¯†åˆ«å¹¶è‡ªåŠ¨åˆå¹¶æ•°æ®</div>
                    </div>
                    <div class="mode-option" data-mode="manual">
                        <div class="mode-title">ğŸ”§ æ‰‹åŠ¨æ¨¡å¼</div>
                        <div class="mode-desc">æ‰‹åŠ¨é€‰æ‹©åˆ—å¹¶åˆ†ç»„åˆå¹¶</div>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ“</span> é€‰æ‹©Excelæ–‡ä»¶
                    <div class="tooltip">?
                        <span class="tooltip-text">æ”¯æŒ.xlså’Œ.xlsxæ ¼å¼æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="addFilesBtn" class="btn btn-primary">
                        <span>â•</span> æ·»åŠ æ–‡ä»¶
                    </button>
                    <button id="addFolderBtn" class="btn btn-secondary" disabled>
                        <span>ğŸ“‚</span> æ·»åŠ æ–‡ä»¶å¤¹ (æ¨¡æ‹Ÿ)
                    </button>
                    <button id="removeSelectedBtn" class="btn btn-secondary">
                        <span>âŒ</span> ç§»é™¤é€‰ä¸­
                    </button>
                    <button id="clearListBtn" class="btn btn-danger">
                        <span>ğŸ—‘ï¸</span> æ¸…ç©ºåˆ—è¡¨
                    </button>
                </div>
                
                <div id="fileList" class="file-list">
                    <div style="text-align: center; color: #95a5a6; padding: 20px;">
                        æš‚æ— æ–‡ä»¶ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ Excelæ–‡ä»¶
                    </div>
                </div>
                
                <div class="stats">
                    <span id="fileCount">å·²é€‰æ‹© 0 ä¸ªæ–‡ä»¶</span>
                    <span id="totalSize">æ€»å¤§å°: 0 KB</span>
                </div>
            </div>

            <!-- æ‰‹åŠ¨é…ç½®åŒºåŸŸ -->
            <div id="manualConfigSection" class="manual-config-section">
                <div class="section-title">
                    <span>ğŸ”§</span> æ‰‹åŠ¨é…ç½®
                </div>
                <div id="manualConfigContent">
                    <p style="color: #7f8c8d; text-align: center; padding: 20px;">
                        è¯·å…ˆæ·»åŠ æ–‡ä»¶ï¼Œç„¶åä¸ºæ¯ä¸ªæ–‡ä»¶è¿›è¡Œé…ç½®
                    </p>
                </div>
            </div>

            <!-- æ‰‹åŠ¨åˆå¹¶åŒºåŸŸ -->
            <div id="manualMergeSection" class="manual-merge-section">
                <div class="section-title">
                    <span>ğŸ”„</span> åˆå¹¶é…ç½®
                </div>
                <div>
                    <div id="partialConfigInfo" class="partial-config-info" style="display: none;">
                        ğŸ’¡ æç¤ºï¼šæ‚¨æ— éœ€é…ç½®æ‰€æœ‰æ–‡ä»¶ã€‚åˆå¹¶æ—¶å°†åªå¤„ç†å·²é…ç½®çš„æ–‡ä»¶ã€‚
                    </div>
                    <div class="group-list" id="groupList">
                        <!-- åŠ¨æ€ç”Ÿæˆç»„æ ‡ç­¾ -->
                    </div>
                    <div class="controls">
                        <button id="startManualMergeBtn" class="btn btn-success" disabled>
                            <span>âš¡</span> å¼€å§‹æ‰‹åŠ¨åˆå¹¶
                        </button>
                    </div>
                    <div id="manualMergePreview" class="merge-preview" style="display: none; margin-top: 10px;">
                        <!-- åˆå¹¶é¢„è§ˆ -->
                    </div>
                </div>
            </div>

            <!-- åˆ†ç»„ä¸‹è½½åŒºåŸŸ -->
            <div id="groupDownloadSection" class="group-download-section">
                <div class="section-title">
                    <span>ğŸ“¥</span> ä¸‹è½½åˆ†ç»„ç»“æœ
                </div>
                <div id="groupDownloadList">
                    <div class="empty-state">
                        æš‚æ— åˆ†ç»„ç»“æœï¼Œè¯·å…ˆè¿è¡Œåˆå¹¶
                    </div>
                </div>
            </div>

            <!-- è‡ªåŠ¨æ¨¡å¼è¾“å‡ºè®¾ç½® -->
            <div id="autoOutputSection" class="section">
                <div class="section-title">
                    <span>ğŸ“¤</span> è¾“å‡ºè®¾ç½®
                </div>
                
                <div class="output-section">
                    <input type="text" id="outputName" class="output-input" value="åˆå¹¶ç»“æœ.xlsx" placeholder="è¾“å‡ºæ–‡ä»¶å">
                    <button id="downloadBtn" class="btn btn-success" disabled>
                        <span>ğŸ’¾</span> ä¸‹è½½åˆå¹¶ç»“æœ
                    </button>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            
            <!-- æ—¥å¿—åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ“‹</span> å¤„ç†æ—¥å¿—
                </div>
                
                <div id="logContainer" class="log-container">
                    <div class="log-entry log-info">[ç³»ç»Ÿ] ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- æ“ä½œåŒºåŸŸ -->
            <div class="action-area">
                <button id="startMergeBtn" class="btn btn-primary" disabled>
                    <span>ğŸš€</span> å¼€å§‹åˆå¹¶
                </button>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div>
                <span id="statusIndicator" class="status-indicator status-ready"></span>
                <span id="statusText">å°±ç»ª</span>
            </div>
            <div id="supportInfo">Powered by SheetJS & Handsontable</div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept=".xls,.xlsx" multiple style="display: none;">

    <script>
        // ==================== åº”ç”¨çŠ¶æ€ ====================
        const state = {
            files: [],
            isProcessing: false,
            progress: 0,
            mode: 'auto', // 'auto' æˆ– 'manual'
            manualConfig: {
                groups: {},
                fileData: {},
                nextGroupIndex: 1
            },
            groupResults: {}
        };

        // ==================== DOMå…ƒç´  ====================
        const elements = {
            fileInput: document.getElementById('fileInput'),
            addFilesBtn: document.getElementById('addFilesBtn'),
            addFolderBtn: document.getElementById('addFolderBtn'),
            removeSelectedBtn: document.getElementById('removeSelectedBtn'),
            clearListBtn: document.getElementById('clearListBtn'),
            fileList: document.getElementById('fileList'),
            fileCount: document.getElementById('fileCount'),
            totalSize: document.getElementById('totalSize'),
            outputName: document.getElementById('outputName'),
            downloadBtn: document.getElementById('downloadBtn'),
            startMergeBtn: document.getElementById('startMergeBtn'),
            logContainer: document.getElementById('logContainer'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            modeOptions: document.querySelectorAll('.mode-option'),
            manualConfigSection: document.getElementById('manualConfigSection'),
            manualConfigContent: document.getElementById('manualConfigContent'),
            manualMergeSection: document.getElementById('manualMergeSection'),
            startManualMergeBtn: document.getElementById('startManualMergeBtn'),
            groupList: document.getElementById('groupList'),
            manualMergePreview: document.getElementById('manualMergePreview'),
            autoOutputSection: document.getElementById('autoOutputSection'),
            partialConfigInfo: document.getElementById('partialConfigInfo'),
            groupDownloadSection: document.getElementById('groupDownloadSection'),
            groupDownloadList: document.getElementById('groupDownloadList')
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        
        // æ£€æŸ¥Handsontableæ˜¯å¦åŠ è½½æˆåŠŸ
        function checkHandsontableLoaded() {
            if (typeof Handsontable === 'undefined') {
                log('âš ï¸ Handsontableåº“åŠ è½½å¤±è´¥ï¼Œå·²å¯ç”¨å¤‡ç”¨æ‰‹åŠ¨è¾“å…¥æ¨¡å¼', 'warning');
                return false;
            }
            return true;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è®°å½•æ—¥å¿—
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, isWorking = false) {
            elements.statusText.textContent = text;
            elements.statusIndicator.className = `status-indicator ${isWorking ? 'status-working' : 'status-ready'}`;
        }

        // æ˜¾ç¤ºè¿›åº¦
        function showProgress(percent) {
            elements.progressContainer.style.display = 'block';
            elements.progressBar.style.width = `${percent}%`;
        }

        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            elements.progressContainer.style.display = 'none';
            elements.progressBar.style.width = '0%';
        }

        // ==================== äº‹ä»¶ç›‘å¬å™¨ ====================
        
        function initEventListeners() {
            // æ¨¡å¼é€‰æ‹©
            elements.modeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const mode = option.dataset.mode;
                    switchMode(mode);
                });
            });

            // æ–‡ä»¶æ“ä½œ
            elements.addFilesBtn.addEventListener('click', () => {
                elements.fileInput.click();
            });
            
            elements.fileInput.addEventListener('change', handleFileSelect);
            
            elements.addFolderBtn.addEventListener('click', () => {
                log('æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®æ–‡ä»¶å¤¹ã€‚è¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶ã€‚', 'warning');
            });
            
            elements.removeSelectedBtn.addEventListener('click', removeSelectedFiles);
            elements.clearListBtn.addEventListener('click', clearFileList);
            elements.startMergeBtn.addEventListener('click', startMergeProcess);
            elements.downloadBtn.addEventListener('click', downloadMergedFile);
            elements.startManualMergeBtn.addEventListener('click', startManualMergeProcess);

            // äº‹ä»¶å§”æ‰˜ï¼šå¤„ç†åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®
            document.addEventListener('click', function(e) {
                // åˆ é™¤ç»„é…ç½®æŒ‰é’®
                if (e.target.matches('.delete-group-btn')) {
                    const fileName = e.target.dataset.file;
                    const groupName = e.target.dataset.group;
                    const modal = e.target.closest('.modal-container');
                    removeGroupConfig(fileName, groupName, modal);
                }
                
                // ä¿å­˜é…ç½®æŒ‰é’®ï¼ˆåœ¨æ¨¡æ€æ¡†ä¸­ï¼‰
                if (e.target.matches('#saveConfig')) {
                    const modal = e.target.closest('.modal-container');
                    if (modal) {
                        const fileName = modal.dataset.fileName;
                        saveFileConfig(fileName, modal);
                    }
                }

                // åˆ†ç»„ä¸‹è½½æŒ‰é’®
                if (e.target.matches('.download-group-btn')) {
                    const groupName = e.target.dataset.groupName;
                    downloadGroupResult(groupName);
                }

                // æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ä¸‹çš„ä¿å­˜æŒ‰é’®
                if (e.target.matches('#saveManualInput')) {
                    const modal = e.target.closest('.modal-container');
                    if (modal) {
                        const fileName = modal.dataset.fileName;
                        saveManualInputConfig(fileName, modal);
                    }
                }

                // é‡è¯•HandsontableåŠ è½½æŒ‰é’®
                if (e.target.matches('#retryHandsontable')) {
                    location.reload();
                }
            });
        }

        // ==================== æ¨¡å¼åˆ‡æ¢ ====================
        
        function switchMode(mode) {
            state.mode = mode;
            
            // æ›´æ–°UIçŠ¶æ€
            elements.modeOptions.forEach(opt => {
                if (opt.dataset.mode === mode) {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });

            // æ˜¾ç¤º/éšè—ç›¸å…³åŒºåŸŸ
            if (mode === 'auto') {
                elements.manualConfigSection.classList.remove('active');
                elements.manualMergeSection.classList.remove('active');
                elements.groupDownloadSection.classList.remove('active');
                elements.autoOutputSection.style.display = 'block';
                elements.startMergeBtn.style.display = 'inline-flex';
                log('åˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼', 'info');
            } else {
                elements.manualConfigSection.classList.add('active');
                elements.manualMergeSection.classList.add('active');
                elements.autoOutputSection.style.display = 'none';
                elements.startMergeBtn.style.display = 'none';
                log('åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼', 'info');
                
                // å¦‚æœå·²ç»æœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºé…ç½®ç•Œé¢
                if (state.files.length > 0) {
                    renderManualConfig();
                    renderGroupList();
                }
            }
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        
        function handleFileSelect(event) {
            const newFiles = Array.from(event.target.files);
            
            // è¿‡æ»¤éExcelæ–‡ä»¶
            const validFiles = newFiles.filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ['xls', 'xlsx'].includes(ext);
            });
            
            // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰
            validFiles.forEach(file => {
                if (!state.files.some(f => f.name === file.name && f.size === file.size)) {
                    state.files.push(file);
                    // åˆå§‹åŒ–æ‰‹åŠ¨é…ç½®æ•°æ®
                    if (state.mode === 'manual') {
                        state.manualConfig.fileData[file.name] = {
                            data: null,
                            hotInstance: null,
                            configured: false,
                            lastSelection: null
                        };
                    }
                }
            });
            
            updateFileList();
            log(`æ·»åŠ äº† ${validFiles.length} ä¸ªExcelæ–‡ä»¶`, 'info');
            
            // å¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œæ¸²æŸ“é…ç½®ç•Œé¢
            if (state.mode === 'manual' && validFiles.length > 0) {
                renderManualConfig();
                renderGroupList();
            }
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            elements.fileInput.value = '';
        }

        function updateFileList() {
            if (state.files.length === 0) {
                elements.fileList.innerHTML = `
                    <div style="text-align: center; color: #95a5a6; padding: 20px;">
                        æš‚æ— æ–‡ä»¶ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ Excelæ–‡ä»¶
                    </div>
                `;
                elements.fileCount.textContent = 'å·²é€‰æ‹© 0 ä¸ªæ–‡ä»¶';
                elements.totalSize.textContent = 'æ€»å¤§å°: 0 KB';
                elements.startMergeBtn.disabled = true;
                elements.downloadBtn.disabled = true;
                elements.startManualMergeBtn.disabled = true;
                return;
            }
            
            // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
            elements.fileList.innerHTML = '';
            let totalSize = 0;
            
            state.files.forEach((file, index) => {
                totalSize += file.size;
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                // æ£€æŸ¥é…ç½®çŠ¶æ€
                const isConfigured = state.mode === 'manual' && 
                    state.manualConfig.fileData[file.name] && 
                    state.manualConfig.fileData[file.name].configured;
                
                const configStatus = isConfigured ? 
                    '<span class="file-config-status">å·²é…ç½®</span>' : 
                    state.mode === 'manual' ? '<span class="file-config-status pending">å¾…é…ç½®</span>' : '';
                
                const configBtn = state.mode === 'manual' ? 
                    `<span class="config-btn" data-index="${index}" data-action="config">âš™ï¸ é…ç½®</span>` : '';
                
                fileItem.innerHTML = `
                    <span class="name">${file.name} (${formatFileSize(file.size)}) ${configStatus}</span>
                    ${configBtn}
                    <span class="remove" data-index="${index}">âœ•</span>
                `;
                
                // ç»‘å®šäº‹ä»¶
                fileItem.querySelector('.remove').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFileByIndex(index);
                });
                
                if (state.mode === 'manual') {
                    fileItem.querySelector('.config-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openConfigForFile(file.name);
                    });
                }
                
                elements.fileList.appendChild(fileItem);
            });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            elements.fileCount.textContent = `å·²é€‰æ‹© ${state.files.length} ä¸ªæ–‡ä»¶`;
            elements.totalSize.textContent = `æ€»å¤§å°: ${formatFileSize(totalSize)}`;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (state.mode === 'auto') {
                elements.startMergeBtn.disabled = state.files.length === 0;
                elements.downloadBtn.disabled = true;
            } else {
                // æ‰‹åŠ¨æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å·²é…ç½®çš„æ–‡ä»¶
                const hasConfiguredFiles = state.files.some(file => 
                    state.manualConfig.fileData[file.name] && 
                    state.manualConfig.fileData[file.name].configured
                );
                const hasGroups = Object.keys(state.manualConfig.groups).length > 0;
                
                elements.startManualMergeBtn.disabled = !hasConfiguredFiles || !hasGroups;
                
                // æ˜¾ç¤ºéƒ¨åˆ†é…ç½®æç¤º
                if (state.files.length > 0 && hasConfiguredFiles) {
                    const allConfigured = state.files.every(file => 
                        state.manualConfig.fileData[file.name] && 
                        state.manualConfig.fileData[file.name].configured
                    );
                    if (!allConfigured) {
                        elements.partialConfigInfo.style.display = 'block';
                    } else {
                        elements.partialConfigInfo.style.display = 'none';
                    }
                } else {
                    elements.partialConfigInfo.style.display = 'none';
                }
            }
        }

        function removeSelectedFiles() {
            if (state.files.length === 0) {
                log('æ²¡æœ‰æ–‡ä»¶å¯ä»¥ç§»é™¤', 'warning');
                return;
            }
            
            if (confirm('ç¡®å®šè¦ç§»é™¤æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
                // æ¸…ç†æ‰‹åŠ¨é…ç½®æ•°æ®
                if (state.mode === 'manual') {
                    state.manualConfig.fileData = {};
                    Object.keys(state.manualConfig.groups).forEach(groupName => {
                        const group = state.manualConfig.groups[groupName];
                        state.files.forEach(file => {
                            if (group.fileConfigs[file.name]) {
                                delete group.fileConfigs[file.name];
                            }
                        });
                    });
                }
                
                state.files = [];
                updateFileList();
                if (state.mode === 'manual') {
                    renderManualConfig();
                    renderGroupList();
                }
                log('å·²æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶', 'info');
            }
        }

        function removeFileByIndex(index) {
            const removed = state.files.splice(index, 1)[0];
            
            // æ¸…ç†æ‰‹åŠ¨é…ç½®æ•°æ®
            if (state.mode === 'manual') {
                if (state.manualConfig.fileData[removed.name]) {
                    delete state.manualConfig.fileData[removed.name];
                }
                
                Object.keys(state.manualConfig.groups).forEach(groupName => {
                    const group = state.manualConfig.groups[groupName];
                    if (group.fileConfigs[removed.name]) {
                        delete group.fileConfigs[removed.name];
                    }
                });
            }
            
            updateFileList();
            if (state.mode === 'manual') {
                renderManualConfig();
                renderGroupList();
            }
            log(`å·²ç§»é™¤æ–‡ä»¶: ${removed.name}`, 'info');
        }

        function clearFileList() {
            if (state.files.length === 0) return;
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
                // æ¸…ç†æ‰‹åŠ¨é…ç½®æ•°æ®
                if (state.mode === 'manual') {
                    state.manualConfig.fileData = {};
                    state.manualConfig.groups = {};
                    state.manualConfig.nextGroupIndex = 1;
                    state.groupResults = {};
                }
                
                state.files = [];
                updateFileList();
                if (state.mode === 'manual') {
                    renderManualConfig();
                    renderGroupList();
                    renderGroupDownloadList();
                }
                log('æ–‡ä»¶åˆ—è¡¨å·²æ¸…ç©º', 'info');
            }
        }

        // ==================== æ‰‹åŠ¨æ¨¡å¼ï¼šé…ç½®ç•Œé¢ ====================
        
        function renderManualConfig() {
            if (state.files.length === 0) {
                elements.manualConfigContent.innerHTML = `
                    <p style="color: #7f8c8d; text-align: center; padding: 20px;">
                        è¯·å…ˆæ·»åŠ æ–‡ä»¶ï¼Œç„¶åä¸ºæ¯ä¸ªæ–‡ä»¶è¿›è¡Œé…ç½®
                    </p>
                `;
                return;
            }

            let html = '';
            state.files.forEach((file, index) => {
                const fileData = state.manualConfig.fileData[file.name];
                const isConfigured = fileData && fileData.configured;
                
                html += `
                    <div class="group-config" data-file="${file.name}">
                        <div class="group-header">
                            <strong>æ–‡ä»¶ ${index + 1}: ${file.name}</strong>
                            ${isConfigured ? 
                                '<span style="color: #2ecc71; font-weight: 600;">âœ“ å·²é…ç½®</span>' : 
                                '<span style="color: #f39c12; font-weight: 600;">âš™ï¸ å¾…é…ç½®</span>'}
                        </div>
                        <div id="config-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${isConfigured ? 
                                `<div class="selection-info">å·²é…ç½® ${Object.keys(getFileConfigurations(file.name)).length} ç»„æ˜ å°„å…³ç³»</div>
                                <button class="btn btn-secondary" onclick="openConfigForFile('${file.name}')">é‡æ–°é…ç½®</button>` :
                                `<button class="btn btn-primary" onclick="openConfigForFile('${file.name}')">å¼€å§‹é…ç½®</button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            elements.manualConfigContent.innerHTML = html;
        }

        // æ‰“å¼€æ–‡ä»¶é…ç½®æ¨¡æ€æ¡†
        window.openConfigForFile = function(fileName) {
            const file = state.files.find(f => f.name === fileName);
            if (!file) {
                log('æ–‡ä»¶æœªæ‰¾åˆ°', 'error');
                return;
            }

            // æ£€æŸ¥Handsontableæ˜¯å¦å¯ç”¨
            const handsontableLoaded = checkHandsontableLoaded();

            // åˆ›å»ºé…ç½®æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal-container';
            modal.dataset.fileName = fileName;
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="background: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">é…ç½®æ–‡ä»¶: ${fileName}</h3>
                        <button id="closeModal" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">âœ• å…³é—­</button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div id="modalContent"></div>
                    </div>
                    <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                        <div id="selectionSummary" style="font-size: 14px; color: #666;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button id="addNewGroup" class="btn btn-primary">â• æ–°å»ºç»„</button>
                            <button id="saveConfig" class="btn btn-success" disabled>ğŸ’¾ ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // å…³é—­æ¨¡æ€æ¡†
            modal.querySelector('#closeModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // åˆå§‹åŒ–é…ç½®å†…å®¹
            if (handsontableLoaded) {
                initFileConfiguration(file, modal);
            } else {
                initManualInputConfiguration(file, modal);
            }
        };

        // ==================== Handsontableæ­£å¸¸æƒ…å†µä¸‹çš„é…ç½® ====================
        
        function initFileConfiguration(file, modal) {
            const modalContent = modal.querySelector('#modalContent');
            const addGroupBtn = modal.querySelector('#addNewGroup');
            const selectionSummary = modal.querySelector('#selectionSummary');
            
            // ä¿å­˜æŒ‰é’®çš„å¼•ç”¨ç®¡ç†å™¨
            const saveBtnManager = {
                element: null,
                update: function() {
                    this.element = modal.querySelector('#saveConfig');
                    return this.element;
                },
                get: function() {
                    return this.element || this.update();
                },
                setEnabled: function(enabled, onClick) {
                    const btn = this.get();
                    if (btn) {
                        btn.disabled = !enabled;
                        btn.onclick = enabled ? onClick : null;
                    }
                }
            };

            // æ£€æŸ¥å¹¶æ›´æ–°ä¿å­˜æŒ‰é’®çŠ¶æ€
            function updateSaveButtonState() {
                const existingConfigs = getFileConfigurations(file.name);
                const hasConfigs = Object.keys(existingConfigs).length > 0;
                
                saveBtnManager.setEnabled(hasConfigs, () => {
                    state.manualConfig.fileData[file.name].configured = true;
                    updateFileList();
                    renderManualConfig();
                    renderGroupList();
                    log(`æ–‡ä»¶ ${file.name} é…ç½®å®Œæˆ`, 'success');
                    document.body.removeChild(modal);
                });
            }

            function renderConfigUI() {
                const fileData = state.manualConfig.fileData[file.name];
                const existingConfigs = getFileConfigurations(file.name);
                
                saveBtnManager.update();
                updateSaveButtonState();

                modalContent.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <p style="margin-bottom: 10px;"><strong>æ­¥éª¤è¯´æ˜ï¼š</strong></p>
                        <ol style="margin-left: 20px; color: #666; font-size: 14px;">
                            <li>ç‚¹å‡»"æ–°å»ºç»„"åˆ›å»ºæ˜ å°„å…³ç³»ç»„</li>
                            <li><strong>åœ¨è¡¨æ ¼ä¸­é€‰æ‹©å‚æ•°ååˆ—ï¼ˆå¯ä»¥æ¡†é€‰æ•´åˆ—æˆ–éƒ¨åˆ†å•å…ƒæ ¼ï¼‰</strong></li>
                            <li><strong>å†é€‰æ‹©æ•°æ®åˆ—ï¼ˆå¯ä»¥æ¡†é€‰æ•´åˆ—ã€å¤šåˆ—æˆ–éƒ¨åˆ†å•å…ƒæ ¼ï¼‰</strong></li>
                            <li>ä¸ºç»„å‘½åå¹¶ä¿å­˜</li>
                            <li>å¯ä»¥åˆ›å»ºå¤šä¸ªç»„ï¼Œæœ€åä¿å­˜æ‰€æœ‰é…ç½®</li>
                        </ol>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 13px;">
                            ğŸ’¡ <strong>æ“ä½œæç¤ºï¼š</strong> 
                            <br>â€¢ <strong>æ¡†é€‰å•å…ƒæ ¼ï¼š</strong> æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨é€‰æ‹©ä»»æ„èŒƒå›´
                            <br>â€¢ <strong>é€‰æ‹©æ•´åˆ—ï¼š</strong> ç‚¹å‡»åˆ—æ ‡é¢˜é€‰æ‹©æ•´åˆ—
                            <br>â€¢ <strong>é€‰æ‹©å¤šåˆ—ï¼š</strong> æ‹–åŠ¨é€‰æ‹©å¤šåˆ—
                            <br>â€¢ <strong>é€‰åŒºä¼šé«˜äº®æ˜¾ç¤º</strong>ï¼Œç‚¹å‡»æŒ‰é’®å³å¯è®¾ç½®
                        </div>
                    </div>
                    <div id="groupsContainer"></div>
                    <div class="handsontable-container" id="hotContainer"></div>
                `;

                // æ˜¾ç¤ºç°æœ‰é…ç½®
                const groupsContainer = modalContent.querySelector('#groupsContainer');
                if (Object.keys(existingConfigs).length > 0) {
                    groupsContainer.innerHTML = '<h4 style="margin: 10px 0;">ç°æœ‰é…ç½®ï¼š</h4>';
                    Object.keys(existingConfigs).forEach(groupName => {
                        const config = existingConfigs[groupName];
                        const paramRange = config.paramRowStart !== undefined ? 
                            ` (è¡Œ${config.paramRowStart + 1}-${config.paramRowEnd + 1})` : '';
                        const dataRange = config.dataRowStart !== undefined ? 
                            ` (è¡Œ${config.dataRowStart + 1}-${config.dataRowEnd + 1})` : '';
                        
                        groupsContainer.innerHTML += `
                            <div class="config-group-item">
                                <div class="group-info">
                                    <strong>${groupName}</strong>: 
                                    å‚æ•°åˆ—: ${config.paramCol + 1}${paramRange}, 
                                    æ•°æ®åˆ—: ${config.dataCols.map(c => c + 1).join(', ')}${dataRange}
                                </div>
                                <div class="group-actions">
                                    <button class="delete-group-btn btn-danger" data-file="${file.name}" data-group="${groupName}">åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                    });
                }

                // æ¸²æŸ“Handsontable
                const container = modalContent.querySelector('#hotContainer');
                const hot = new Handsontable(container, {
                    data: fileData.data,
                    rowHeaders: true,
                    colHeaders: true,
                    height: '400px',
                    width: '100%',
                    licenseKey: 'non-commercial-and-evaluation',
                    selectionMode: 'multiple',
                    manualColumnResize: true,
                    manualRowResize: true,
                    highlightSelection: true,
                    contextMenu: true,
                    readOnly: true,
                    afterSelectionEnd: function(r1, c1, r2, c2) {
                        const selection = hot.getSelected();
                        if (selection && selection.length > 0) {
                            fileData.lastSelection = selection;
                            updateSelectionStatus(selection);
                        }
                    }
                });

                fileData.hotInstance = hot;

                // ä¸´æ—¶å­˜å‚¨å½“å‰é€‰æ‹©çš„ç»„é…ç½®
                let currentGroupConfig = {
                    name: '',
                    paramCol: null,
                    paramRowStart: null,
                    paramRowEnd: null,
                    dataCols: [],
                    dataRowStart: null,
                    dataRowEnd: null
                };

                // æ›´æ–°é€‰åŒºçŠ¶æ€æ˜¾ç¤º
                function updateSelectionStatus(selection) {
                    if (!selection || selection.length === 0) return;
                    
                    const cols = new Set();
                    const rows = new Set();
                    
                    selection.forEach(([r1, c1, r2, c2]) => {
                        const minRow = Math.min(r1, r2);
                        const maxRow = Math.max(r1, r2);
                        const minCol = Math.min(c1, c2);
                        const maxCol = Math.max(c1, c2);
                        
                        for (let r = minRow; r <= maxRow; r++) rows.add(r);
                        for (let c = minCol; c <= maxCol; c++) cols.add(c);
                    });
                    
                    const colList = Array.from(cols).map(c => c + 1).join(', ');
                    const rowList = Array.from(rows).sort((a, b) => a - b);
                    const rowRange = rowList.length > 0 ? `è¡Œ${rowList[0] + 1}-${rowList[rowList.length - 1] + 1}` : '';
                    const selectionType = rowList.length === (fileData.data.length - 1) ? 'ï¼ˆæ•´åˆ—ï¼‰' : 'ï¼ˆéƒ¨åˆ†å•å…ƒæ ¼ï¼‰';
                    
                    selectionSummary.innerHTML = `å½“å‰é€‰åŒº: ${colList}åˆ—, ${rowRange} ${selectionType} | <strong>è¯·æ ¹æ®éœ€è¦ç‚¹å‡»æŒ‰é’®è®¾ç½®</strong>`;
                }

                // æ–°å»ºç»„æŒ‰é’®
                addGroupBtn.addEventListener('click', () => {
                    // é‡ç½®å½“å‰é…ç½®
                    currentGroupConfig = {
                        name: `ç»„${state.manualConfig.nextGroupIndex}`,
                        paramCol: null,
                        paramRowStart: null,
                        paramRowEnd: null,
                        dataCols: [],
                        dataRowStart: null,
                        dataRowEnd: null
                    };

                    // åˆ›å»ºç»„é…ç½®UI
                    const groupConfigDiv = document.createElement('div');
                    groupConfigDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; margin: 10px 0; border-radius: 6px;';

                    // æ£€æŸ¥æ˜¯å¦æœ‰å·²å­˜åœ¨çš„ç»„å
                    const existingGroupNames = Object.keys(state.manualConfig.groups);
                    let groupNameHTML = '';

                    if (existingGroupNames.length > 0) {
                        groupNameHTML = `
                            <div class="group-name-container">
                                <select id="groupSelect" class="group-name-input">
                                    <option value="">-- é€‰æ‹©å·²æœ‰ç»„æˆ–æ–°å»º --</option>
                                    ${existingGroupNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                                <input type="text" id="groupName" class="group-name-input" value="${currentGroupConfig.name}" placeholder="è¾“å…¥æ–°ç»„å" style="display: none;">
                                <span class="new-group-toggle" id="toggleNewGroup">æˆ–æ–°å»ºç»„</span>
                            </div>
                        `;
                    } else {
                        groupNameHTML = `
                            <div class="group-name-container">
                                <input type="text" id="groupName" class="group-name-input" value="${currentGroupConfig.name}" placeholder="è¾“å…¥ç»„å">
                            </div>
                        `;
                    }

                    groupConfigDiv.innerHTML = `
                        ${groupNameHTML}
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="setParamCol">
                                âœ“ è®¾ä¸ºå‚æ•°åˆ—
                                <span id="paramSelectionInfo" class="selection-mode-indicator" style="display: none;"></span>
                            </button>
                            <button class="btn btn-success" id="setDataCols">
                                âœ“ è®¾ä¸ºæ•°æ®åˆ—
                                <span id="dataSelectionInfo" class="selection-mode-indicator" style="display: none;"></span>
                            </button>
                            <button class="btn btn-secondary" id="saveThisGroup">ğŸ’¾ ä¿å­˜æœ¬ç»„</button>
                            <button class="btn btn-danger" id="cancelGroup">å–æ¶ˆ</button>
                        </div>
                        <div id="selectionRangeInfo" class="selection-range-info" style="display: none;"></div>
                        <div style="font-size: 12px; color: #666;">
                            çŠ¶æ€: <span id="currentSelectionInfo">ç­‰å¾…é€‰æ‹©...</span>
                        </div>
                    `;

                    modalContent.insertBefore(groupConfigDiv, modalContent.querySelector('#hotContainer'));

                    // ç»„åé€‰æ‹©/è¾“å…¥é€»è¾‘
                    const groupSelect = groupConfigDiv.querySelector('#groupSelect');
                    const groupNameInput = groupConfigDiv.querySelector('#groupName');
                    const toggleNewGroup = groupConfigDiv.querySelector('#toggleNewGroup');

                    if (groupSelect && toggleNewGroup) {
                        groupSelect.addEventListener('change', (e) => {
                            if (e.target.value) {
                                currentGroupConfig.name = e.target.value;
                                groupNameInput.style.display = 'none';
                                toggleNewGroup.style.display = 'inline';
                                toggleNewGroup.textContent = 'åˆ‡æ¢ä¸ºæ–°å»ºç»„';
                                log(`å·²é€‰æ‹©ç»„: ${e.target.value}`, 'info');
                            } else {
                                groupNameInput.style.display = 'inline';
                                groupNameInput.focus();
                                toggleNewGroup.style.display = 'none';
                            }
                        });

                        toggleNewGroup.addEventListener('click', () => {
                            if (groupNameInput.style.display === 'none') {
                                groupNameInput.style.display = 'inline';
                                groupNameInput.focus();
                                groupSelect.style.display = 'none';
                                toggleNewGroup.textContent = 'åˆ‡æ¢ä¸ºé€‰æ‹©ç»„';
                            } else {
                                groupNameInput.style.display = 'none';
                                groupSelect.style.display = 'inline';
                                toggleNewGroup.textContent = 'æˆ–æ–°å»ºç»„';
                            }
                        });

                        groupNameInput.addEventListener('input', (e) => {
                            currentGroupConfig.name = e.target.value;
                        });
                    } else if (groupNameInput) {
                        groupNameInput.addEventListener('input', (e) => {
                            currentGroupConfig.name = e.target.value;
                        });
                    }

                    // è®¾ç½®å‚æ•°åˆ—æŒ‰é’®
                    groupConfigDiv.querySelector('#setParamCol').addEventListener('click', () => {
                        let selection = fileData.lastSelection;
                        if (!selection || selection.length === 0) {
                            selection = hot.getSelected();
                        }

                        if (!selection || selection.length === 0) {
                            alert('è¯·å…ˆåœ¨è¡¨æ ¼ä¸­é€‰æ‹©å‚æ•°åˆ—\n\næ“ä½œæ–¹æ³•ï¼š\n1. ç”¨é¼ æ ‡å·¦é”®æ‹–åŠ¨é€‰æ‹©ä»»æ„èŒƒå›´\n2. é€‰åŒºä¼šé«˜äº®æ˜¾ç¤º\n3. ç„¶åç‚¹å‡»"è®¾ä¸ºå‚æ•°åˆ—"æŒ‰é’®');
                            return;
                        }

                        // è·å–é€‰åŒºèŒƒå›´
                        const rows = new Set();
                        const cols = new Set();
                        selection.forEach(([r1, c1, r2, c2]) => {
                            const minRow = Math.min(r1, r2);
                            const maxRow = Math.max(r1, r2);
                            const minCol = Math.min(c1, c2);
                            const maxCol = Math.max(c1, c2);
                            
                            for (let r = minRow; r <= maxRow; r++) rows.add(r);
                            for (let c = minCol; c <= maxCol; c++) cols.add(c);
                        });

                        if (cols.size > 1) {
                            alert('å‚æ•°åˆ—åªèƒ½é€‰æ‹©1åˆ—ï¼');
                            return;
                        }

                        const selectedCol = Math.min(...cols);
                        const rowArray = Array.from(rows).sort((a, b) => a - b);
                        const isFullColumn = rowArray.length === (fileData.data.length - 1);

                        currentGroupConfig.paramCol = selectedCol;
                        currentGroupConfig.paramRowStart = isFullColumn ? 1 : rowArray[0];
                        currentGroupConfig.paramRowEnd = isFullColumn ? fileData.data.length - 1 : rowArray[rowArray.length - 1];

                        const selectionType = isFullColumn ? 'æ•´åˆ—' : `éƒ¨åˆ†å•å…ƒæ ¼ (è¡Œ${currentGroupConfig.paramRowStart + 1}-${currentGroupConfig.paramRowEnd + 1})`;
                        log(`å·²è®¾ç½®å‚æ•°åˆ—: ç¬¬${selectedCol + 1}åˆ— - ${selectionType}`, 'success');
                        
                        const infoDiv = groupConfigDiv.querySelector('#currentSelectionInfo');
                        infoDiv.innerHTML = `<span style="color: #2ecc71;">âœ“ å‚æ•°åˆ—: ç¬¬${selectedCol + 1}åˆ— (${selectionType})</span>`;

                        const paramIndicator = groupConfigDiv.querySelector('#paramSelectionInfo');
                        paramIndicator.textContent = isFullColumn ? 'æ•´åˆ—' : 'éƒ¨åˆ†';
                        paramIndicator.style.display = 'inline-block';

                        updateRangeInfo();
                    });

                    // è®¾ç½®æ•°æ®åˆ—æŒ‰é’®
                    groupConfigDiv.querySelector('#setDataCols').addEventListener('click', () => {
                        let selection = fileData.lastSelection;
                        if (!selection || selection.length === 0) {
                            selection = hot.getSelected();
                        }

                        if (!selection || selection.length === 0) {
                            alert('è¯·å…ˆåœ¨è¡¨æ ¼ä¸­é€‰æ‹©æ•°æ®åˆ—\n\næ“ä½œæ–¹æ³•ï¼š\n1. ç”¨é¼ æ ‡å·¦é”®æ‹–åŠ¨é€‰æ‹©ä»»æ„èŒƒå›´\n2. é€‰åŒºä¼šé«˜äº®æ˜¾ç¤º\n3. ç„¶åç‚¹å‡»"è®¾ä¸ºæ•°æ®åˆ—"æŒ‰é’®');
                            return;
                        }

                        // è·å–é€‰åŒºèŒƒå›´
                        const rows = new Set();
                        const cols = new Set();
                        selection.forEach(([r1, c1, r2, c2]) => {
                            const minRow = Math.min(r1, r2);
                            const maxRow = Math.max(r1, r2);
                            const minCol = Math.min(c1, c2);
                            const maxCol = Math.max(c1, c2);
                            
                            for (let r = minRow; r <= maxRow; r++) rows.add(r);
                            for (let c = minCol; c <= maxCol; c++) cols.add(c);
                        });

                        const selectedCols = Array.from(cols);
                        const rowArray = Array.from(rows).sort((a, b) => a - b);
                        const isFullColumn = rowArray.length === (fileData.data.length - 1);

                        currentGroupConfig.dataCols = selectedCols;
                        currentGroupConfig.dataRowStart = isFullColumn ? 1 : rowArray[0];
                        currentGroupConfig.dataRowEnd = isFullColumn ? fileData.data.length - 1 : rowArray[rowArray.length - 1];

                        const selectionType = isFullColumn ? 'æ•´åˆ—' : `éƒ¨åˆ†å•å…ƒæ ¼ (è¡Œ${currentGroupConfig.dataRowStart + 1}-${currentGroupConfig.dataRowEnd + 1})`;
                        const colText = selectedCols.length === 1 ? `ç¬¬${selectedCols[0] + 1}åˆ—` : `${selectedCols.map(c => c + 1).join(', ')}åˆ—`;
                        log(`å·²è®¾ç½®æ•°æ®åˆ—: ${colText} - ${selectionType}`, 'success');
                        
                        const infoDiv = groupConfigDiv.querySelector('#currentSelectionInfo');
                        const existingText = infoDiv.innerHTML.includes('å‚æ•°åˆ—') ? infoDiv.innerHTML + ' | ' : '';
                        infoDiv.innerHTML = `${existingText}<span style="color: #2ecc71;">âœ“ æ•°æ®åˆ—: ${colText} (${selectionType})</span>`;

                        const dataIndicator = groupConfigDiv.querySelector('#dataSelectionInfo');
                        dataIndicator.textContent = isFullColumn ? 'æ•´åˆ—' : 'éƒ¨åˆ†';
                        dataIndicator.style.display = 'inline-block';

                        updateRangeInfo();
                    });

                    // æ›´æ–°é€‰æ‹©èŒƒå›´ä¿¡æ¯æ˜¾ç¤º
                    function updateRangeInfo() {
                        const rangeInfoDiv = groupConfigDiv.querySelector('#selectionRangeInfo');
                        if (currentGroupConfig.paramCol !== null && currentGroupConfig.dataCols.length > 0) {
                            const paramRange = currentGroupConfig.paramRowStart !== null ? 
                                `å‚æ•°è¡Œ: ${currentGroupConfig.paramRowStart + 1}-${currentGroupConfig.paramRowEnd + 1}` : 'å‚æ•°è¡Œ: æ•´åˆ—';
                            const dataRange = currentGroupConfig.dataRowStart !== null ? 
                                `æ•°æ®è¡Œ: ${currentGroupConfig.dataRowStart + 1}-${currentGroupConfig.dataRowEnd + 1}` : 'æ•°æ®è¡Œ: æ•´åˆ—';
                            
                            rangeInfoDiv.innerHTML = `ğŸ“ é€‰æ‹©èŒƒå›´: ${paramRange} | ${dataRange}`;
                            rangeInfoDiv.style.display = 'block';
                        }
                    }

                    // ä¿å­˜æœ¬ç»„æŒ‰é’®
                    groupConfigDiv.querySelector('#saveThisGroup').addEventListener('click', () => {
                        if (!currentGroupConfig.name) {
                            alert('è¯·è¾“å…¥ç»„å');
                            return;
                        }
                        if (currentGroupConfig.paramCol === null) {
                            alert('è¯·è®¾ç½®å‚æ•°åˆ—');
                            return;
                        }
                        if (currentGroupConfig.dataCols.length === 0) {
                            alert('è¯·è®¾ç½®æ•°æ®åˆ—');
                            return;
                        }

                        // ä¿å­˜åˆ°çŠ¶æ€
                        if (!state.manualConfig.groups[currentGroupConfig.name]) {
                            state.manualConfig.groups[currentGroupConfig.name] = {
                                fileConfigs: {}
                            };
                            state.manualConfig.nextGroupIndex++;
                        }

                        state.manualConfig.groups[currentGroupConfig.name].fileConfigs[file.name] = {
                            paramCol: currentGroupConfig.paramCol,
                            paramRowStart: currentGroupConfig.paramRowStart,
                            paramRowEnd: currentGroupConfig.paramRowEnd,
                            dataCols: [...currentGroupConfig.dataCols],
                            dataRowStart: currentGroupConfig.dataRowStart,
                            dataRowEnd: currentGroupConfig.dataRowEnd
                        };

                        log(`å·²ä¿å­˜ç»„é…ç½®: ${currentGroupConfig.name} - æ–‡ä»¶: ${file.name}`, 'success');
                        
                        // é‡æ–°æ¸²æŸ“é…ç½®ç•Œé¢
                        renderConfigUI();
                        
                        // é‡æ–°æ¸²æŸ“ç»„åˆ—è¡¨
                        renderGroupList();

                        // ç«‹å³æ£€æŸ¥å¹¶å¯ç”¨ä¿å­˜æŒ‰é’®
                        updateSaveButtonState();
                    });

                    // å–æ¶ˆæŒ‰é’®
                    groupConfigDiv.querySelector('#cancelGroup').addEventListener('click', () => {
                        groupConfigDiv.remove();
                    });
                });
            }

            // å¦‚æœè¿˜æ²¡æœ‰è¯»å–æ–‡ä»¶æ•°æ®ï¼Œå…ˆè¯»å–
            if (!state.manualConfig.fileData[file.name] || !state.manualConfig.fileData[file.name].data) {
                readFileData(file).then(data => {
                    state.manualConfig.fileData[file.name] = {
                        data: data,
                        hotInstance: null,
                        configured: false,
                        lastSelection: null
                    };
                    renderConfigUI();
                }).catch(err => {
                    log(`è¯»å–æ–‡ä»¶å¤±è´¥: ${err.message}`, 'error');
                    modalContent.innerHTML = `<div style="color: #e74c3c;">è¯»å–æ–‡ä»¶å¤±è´¥: ${err.message}</div>`;
                });
            } else {
                renderConfigUI();
            }
        }

        // ==================== Handsontableå¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨è¾“å…¥ ====================
        
        function initManualInputConfiguration(file, modal) {
            const modalContent = modal.querySelector('#modalContent');
            const addGroupBtn = modal.querySelector('#addNewGroup');
            const selectionSummary = modal.querySelector('#selectionSummary');
            
            // éšè—åŸæŒ‰é’®ï¼Œæ˜¾ç¤ºæç¤º
            addGroupBtn.style.display = 'none';
            selectionSummary.innerHTML = 'Handsontableåº“åŠ è½½å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼';
            
            // æ˜¾ç¤ºé”™è¯¯æç¤ºå’Œé‡è¯•æŒ‰é’®
            modalContent.innerHTML = `
                <div class="handsontable-error">
                    <strong>âš ï¸ æ— æ³•åŠ è½½è¡¨æ ¼é¢„è§ˆç»„ä»¶</strong>
                    <p>åŸå› å¯èƒ½æ˜¯ï¼š</p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                        <li>é˜²ç«å¢™é˜»æ­¢äº†CDN</li>
                        <li>æµè§ˆå™¨å®‰å…¨è®¾ç½®</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <ol style="margin-left: 20px; margin-top: 5px;">
                        <li>ç‚¹å‡»"é‡è¯•"æŒ‰é’®é‡æ–°åŠ è½½</li>
                        <li>æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼ˆåœ¨ä¸‹æ–¹è¾“å…¥åˆ—å·ï¼‰</li>
                    </ol>
                    <button id="retryHandsontable" class="retry-btn">ğŸ”„ é‡è¯•åŠ è½½</button>
                </div>

                <div class="manual-input-mode active">
                    <h4 style="margin: 10px 0;">æ‰‹åŠ¨è¾“å…¥é…ç½®</h4>
                    <div class="manual-input-group">
                        <label>ç»„åï¼š</label>
                        <input type="text" id="manualGroupName" value="ç»„${state.manualConfig.nextGroupIndex}" placeholder="è¾“å…¥ç»„å">
                    </div>
                    <div class="manual-input-group">
                        <label>å‚æ•°åˆ—å·ï¼š</label>
                        <input type="number" id="manualParamCol" placeholder="ä¾‹å¦‚: 1">
                        <div class="help-text">ä»1å¼€å§‹ï¼Œåªèƒ½è¾“å…¥1ä¸ªæ•°å­—</div>
                    </div>
                    <div class="manual-input-group">
                        <label>å‚æ•°è¡ŒèŒƒå›´ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="manualParamRowStart" placeholder="èµ·å§‹è¡Œ" style="width: 50%;">
                            <input type="number" id="manualParamRowEnd" placeholder="ç»“æŸè¡Œ" style="width: 50%;">
                        </div>
                        <div class="help-text">ä¸å¡«åˆ™å¤„ç†æ‰€æœ‰è¡Œ</div>
                    </div>
                    <div class="manual-input-group">
                        <label>æ•°æ®åˆ—å·ï¼š</label>
                        <input type="text" id="manualDataCols" placeholder="ä¾‹å¦‚: 2,3,4">
                        <div class="help-text">å¤šä¸ªåˆ—ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: 2,3,4</div>
                    </div>
                    <div class="manual-input-group">
                        <label>æ•°æ®è¡ŒèŒƒå›´ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="manualDataRowStart" placeholder="èµ·å§‹è¡Œ" style="width: 50%;">
                            <input type="number" id="manualDataRowEnd" placeholder="ç»“æŸè¡Œ" style="width: 50%;">
                        </div>
                        <div class="help-text">ä¸å¡«åˆ™å¤„ç†æ‰€æœ‰è¡Œ</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button id="saveManualInput" class="btn btn-success">
                            <span>ğŸ’¾</span> ä¿å­˜é…ç½®
                        </button>
                    </div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px;">
                        <strong>æç¤ºï¼š</strong> è¯·æŸ¥çœ‹Excelæ–‡ä»¶ï¼Œç¡®å®šåˆ—å·å’Œè¡Œå·ã€‚æ ‡é¢˜è¡Œé€šå¸¸æ˜¯ç¬¬1è¡Œï¼Œæ•°æ®ä»ç¬¬2è¡Œå¼€å§‹ã€‚
                    </div>
                </div>
            `;

            // ä¿å­˜æ‰‹åŠ¨è¾“å…¥é…ç½®
            window.saveManualInputConfig = function(fileName, modal) {
                const groupName = document.getElementById('manualGroupName').value.trim();
                const paramCol = parseInt(document.getElementById('manualParamCol').value);
                const paramRowStart = document.getElementById('manualParamRowStart').value;
                const paramRowEnd = document.getElementById('manualParamRowEnd').value;
                const dataColsStr = document.getElementById('manualDataCols').value.trim();
                const dataRowStart = document.getElementById('manualDataRowStart').value;
                const dataRowEnd = document.getElementById('manualDataRowEnd').value;

                // éªŒè¯è¾“å…¥
                if (!groupName) {
                    alert('è¯·è¾“å…¥ç»„å');
                    return;
                }
                if (isNaN(paramCol) || paramCol < 1) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å‚æ•°åˆ—å·ï¼ˆä»1å¼€å§‹ï¼‰');
                    return;
                }
                if (!dataColsStr) {
                    alert('è¯·è¾“å…¥æ•°æ®åˆ—å·');
                    return;
                }

                // è§£ææ•°æ®åˆ—
                const dataCols = dataColsStr.split(',').map(s => parseInt(s.trim()) - 1).filter(n => !isNaN(n) && n >= 0);
                if (dataCols.length === 0) {
                    alert('æ•°æ®åˆ—å·æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æ•°å­—å¹¶ç”¨é€—å·åˆ†éš”');
                    return;
                }

                // ä¿å­˜é…ç½®
                if (!state.manualConfig.groups[groupName]) {
                    state.manualConfig.groups[groupName] = {
                        fileConfigs: {}
                    };
                    state.manualConfig.nextGroupIndex++;
                }

                state.manualConfig.groups[groupName].fileConfigs[fileName] = {
                    paramCol: paramCol - 1,
                    paramRowStart: paramRowStart ? parseInt(paramRowStart) - 1 : undefined,
                    paramRowEnd: paramRowEnd ? parseInt(paramRowEnd) - 1 : undefined,
                    dataCols: dataCols,
                    dataRowStart: dataRowStart ? parseInt(dataRowStart) - 1 : undefined,
                    dataRowEnd: dataRowEnd ? parseInt(dataRowEnd) - 1 : undefined
                };

                // æ ‡è®°æ–‡ä»¶ä¸ºå·²é…ç½®
                if (state.manualConfig.fileData[fileName]) {
                    state.manualConfig.fileData[fileName].configured = true;
                } else {
                    state.manualConfig.fileData[fileName] = {
                        data: null,
                        hotInstance: null,
                        configured: true,
                        lastSelection: null
                    };
                }

                log(`å·²ä¿å­˜æ‰‹åŠ¨é…ç½®: ${groupName} - æ–‡ä»¶: ${fileName}`, 'success');
                
                // æ›´æ–°ç•Œé¢
                updateFileList();
                renderManualConfig();
                renderGroupList();

                // å…³é—­æ¨¡æ€æ¡†
                if (modal && modal.parentNode) {
                    document.body.removeChild(modal);
                }
            };
        }

        // ==================== é…ç½®ç®¡ç† ====================
        
        function saveFileConfig(fileName, modal) {
            const fileData = state.manualConfig.fileData[fileName];
            if (!fileData) {
                log('æ–‡ä»¶æ•°æ®æœªæ‰¾åˆ°', 'error');
                return;
            }

            const hasConfigs = Object.keys(getFileConfigurations(fileName)).length > 0;
            if (!hasConfigs) {
                alert('è¯·å…ˆåˆ›å»ºå¹¶ä¿å­˜è‡³å°‘ä¸€ä¸ªç»„é…ç½®');
                return;
            }

            fileData.configured = true;
            updateFileList();
            renderManualConfig();
            renderGroupList();
            log(`æ–‡ä»¶ ${fileName} é…ç½®å®Œæˆ`, 'success');
            
            // å…³é—­æ¨¡æ€æ¡†
            if (modal && modal.parentNode) {
                document.body.removeChild(modal);
            }
        }

        function readFileData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // è½¬æ¢ä¸ºäºŒç»´æ•°ç»„
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                        
                        if (jsonData.length === 0) {
                            reject(new Error('è¡¨æ ¼ä¸ºç©º'));
                            return;
                        }
                        
                        resolve(jsonData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = () => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        function getFileConfigurations(fileName) {
            const configs = {};
            Object.keys(state.manualConfig.groups).forEach(groupName => {
                const group = state.manualConfig.groups[groupName];
                if (group.fileConfigs[fileName]) {
                    configs[groupName] = group.fileConfigs[fileName];
                }
            });
            return configs;
        }

        function removeGroupConfig(fileName, groupName, modal) {
            if (state.manualConfig.groups[groupName]) {
                delete state.manualConfig.groups[groupName].fileConfigs[fileName];
                
                if (Object.keys(state.manualConfig.groups[groupName].fileConfigs).length === 0) {
                    delete state.manualConfig.groups[groupName];
                }
                
                const remainingConfigs = getFileConfigurations(fileName);
                if (Object.keys(remainingConfigs).length === 0) {
                    if (state.manualConfig.fileData[fileName]) {
                        state.manualConfig.fileData[fileName].configured = false;
                    }
                }
                
                log(`å·²åˆ é™¤ç»„é…ç½®: ${groupName} - æ–‡ä»¶: ${fileName}`, 'info');
                
                if (modal) {
                    const modalContent = modal.querySelector('#modalContent');
                    if (modalContent) {
                        const existingConfigs = getFileConfigurations(fileName);
                        const groupsContainer = modalContent.querySelector('#groupsContainer');
                        
                        if (groupsContainer) {
                            if (Object.keys(existingConfigs).length > 0) {
                                let html = '<h4 style="margin: 10px 0;">ç°æœ‰é…ç½®ï¼š</h4>';
                                Object.keys(existingConfigs).forEach(groupName => {
                                    const config = existingConfigs[groupName];
                                    const paramRange = config.paramRowStart !== undefined ? 
                                        ` (è¡Œ${config.paramRowStart + 1}-${config.paramRowEnd + 1})` : '';
                                    const dataRange = config.dataRowStart !== undefined ? 
                                        ` (è¡Œ${config.dataRowStart + 1}-${config.dataRowEnd + 1})` : '';
                                    
                                    html += `
                                        <div class="config-group-item">
                                            <div class="group-info">
                                                <strong>${groupName}</strong>: 
                                                å‚æ•°åˆ—: ${config.paramCol + 1}${paramRange}, 
                                                æ•°æ®åˆ—: ${config.dataCols.map(c => c + 1).join(', ')}${dataRange}
                                            </div>
                                            <div class="group-actions">
                                                <button class="delete-group-btn btn-danger" data-file="${fileName}" data-group="${groupName}">åˆ é™¤</button>
                                            </div>
                                        </div>
                                    `;
                                });
                                groupsContainer.innerHTML = html;
                            } else {
                                groupsContainer.innerHTML = '';
                            }
                        }
                        
                        const saveBtn = modal.querySelector('#saveConfig');
                        if (saveBtn) {
                            saveBtn.disabled = Object.keys(existingConfigs).length === 0;
                        }
                    }
                }
                
                renderManualConfig();
                renderGroupList();
                updateFileList();
            }
        }

        function renderGroupList() {
            const groups = Object.keys(state.manualConfig.groups);
            if (groups.length === 0) {
                elements.groupList.innerHTML = '<span style="color: #7f8c8d;">æš‚æ— åˆ†ç»„ï¼Œè¯·å…ˆé…ç½®æ–‡ä»¶</span>';
                elements.startManualMergeBtn.disabled = true;
                elements.partialConfigInfo.style.display = 'none';
                return;
            }

            let html = '';
            groups.forEach(groupName => {
                const group = state.manualConfig.groups[groupName];
                const fileCount = Object.keys(group.fileConfigs).length;
                html += `
                    <div class="group-tag">
                        ${groupName}
                        <span class="count">${fileCount}ä¸ªæ–‡ä»¶</span>
                    </div>
                `;
            });

            elements.groupList.innerHTML = html;
            
            const hasConfiguredFiles = state.files.some(file => 
                state.manualConfig.fileData[file.name] && 
                state.manualConfig.fileData[file.name].configured
            );
            elements.startManualMergeBtn.disabled = !hasConfiguredFiles || groups.length === 0;
            
            if (state.files.length > 0 && hasConfiguredFiles) {
                const allConfigured = state.files.every(file => 
                    state.manualConfig.fileData[file.name] && 
                    state.manualConfig.fileData[file.name].configured
                );
                if (!allConfigured) {
                    elements.partialConfigInfo.style.display = 'block';
                } else {
                    elements.partialConfigInfo.style.display = 'none';
                }
            } else {
                elements.partialConfigInfo.style.display = 'none';
            }
        }

        // ==================== æ‰‹åŠ¨åˆå¹¶å¤„ç†ï¼ˆæ”¯æŒæ¡†é€‰å•å…ƒæ ¼ï¼‰ ====================
        
        async function startManualMergeProcess() {
            if (state.isProcessing) return;

            const configuredFiles = state.files.filter(file => 
                state.manualConfig.fileData[file.name] && 
                state.manualConfig.fileData[file.name].configured
            );

            if (configuredFiles.length === 0) {
                log('æ²¡æœ‰å·²é…ç½®çš„æ–‡ä»¶', 'error');
                return;
            }

            const groups = Object.keys(state.manualConfig.groups);
            if (groups.length === 0) {
                log('è¯·å…ˆåˆ›å»ºåˆ†ç»„', 'error');
                return;
            }

            state.isProcessing = true;
            elements.startManualMergeBtn.disabled = true;
            updateStatus('æ­£åœ¨åˆ†ç»„åˆå¹¶...', true);
            
            state.groupResults = {};
            elements.groupDownloadSection.classList.remove('active');
            
            try {
                showProgress(5);
                let progress = 5;

                // è¯»å–æ‰€æœ‰å·²é…ç½®æ–‡ä»¶çš„æ•°æ®
                const allData = {};
                for (const file of configuredFiles) {
                    progress += 5;
                    showProgress(progress);
                    
                    if (!state.manualConfig.fileData[file.name].data) {
                        const data = await readFileData(file);
                        state.manualConfig.fileData[file.name].data = data;
                    }
                    allData[file.name] = state.manualConfig.fileData[file.name].data;
                }

                const groupCount = groups.length;
                let completedGroups = 0;

                log(`å¼€å§‹å¤„ç† ${groupCount} ä¸ªåˆ†ç»„...`, 'info');

                for (const groupName of groups) {
                    const group = state.manualConfig.groups[groupName];
                    
                    log(`æ­£åœ¨å¤„ç†åˆ†ç»„: ${groupName}`, 'info');
                    showProgress(5 + (completedGroups / groupCount) * 80);

                    const groupData = {
                        parameters: [],
                        data: []
                    };

                    for (const file of configuredFiles) {
                        const fileConfig = group.fileConfigs[file.name];
                        if (!fileConfig) {
                            log(`  è·³è¿‡æ–‡ä»¶ ${file.name} (æ­¤ç»„æœªé…ç½®)`, 'warning');
                            continue;
                        }

                        const data = allData[file.name];
                        if (!data || data.length === 0) continue;

                        const paramCol = fileConfig.paramCol;
                        const paramRowStart = fileConfig.paramRowStart || 1;
                        const paramRowEnd = fileConfig.paramRowEnd || (data.length - 1);
                        const dataCols = fileConfig.dataCols;
                        const dataRowStart = fileConfig.dataRowStart || 1;
                        const dataRowEnd = fileConfig.dataRowEnd || (data.length - 1);

                        const actualRowStart = Math.max(paramRowStart, dataRowStart);
                        const actualRowEnd = Math.min(paramRowEnd, dataRowEnd);

                        if (actualRowStart > actualRowEnd) {
                            log(`  è·³è¿‡æ–‡ä»¶ ${file.name} (è¡ŒèŒƒå›´ä¸åŒ¹é…)`, 'warning');
                            continue;
                        }

                        for (let row = actualRowStart; row <= actualRowEnd; row++) {
                            const paramCell = data[row][paramCol];
                            if (!paramCell || String(paramCell).trim() === '') continue;

                            const param = String(paramCell).trim();
                            const rowData = [param];

                            for (const col of dataCols) {
                                const cell = data[row][col];
                                const value = cell && !isNaN(parseFloat(cell)) ? parseFloat(cell) : 0;
                                rowData.push(value);
                            }

                            if (groupData.parameters.length === 0) {
                                groupData.parameters.push(param);
                                groupData.data.push(rowData);
                            } else {
                                const existingIndex = groupData.parameters.indexOf(param);
                                if (existingIndex === -1) {
                                    groupData.parameters.push(param);
                                    groupData.data.push(rowData);
                                } else {
                                    for (let i = 1; i < rowData.length; i++) {
                                        groupData.data[existingIndex][i] += rowData[i];
                                    }
                                }
                            }
                        }

                        log(`  æ–‡ä»¶ ${file.name}: æå–å®Œæˆ (è¡Œ${actualRowStart + 1}-${actualRowEnd + 1})`, 'info');
                    }

                    if (groupData.data.length > 0) {
                        const workbook = XLSX.utils.book_new();

                        // 1. åˆå¹¶ç»“æœsheet
                        const resultSheetData = [['å‚æ•°', ...Array.from({length: groupData.data[0].length - 1}, (_, i) => `æ•°æ®${i+1}`)]];
                        resultSheetData.push(...groupData.data);
                        const resultWorksheet = XLSX.utils.aoa_to_sheet(resultSheetData);
                        XLSX.utils.book_append_sheet(workbook, resultWorksheet, 'åˆå¹¶ç»“æœ');

                        // 2. è®¡ç®—æ˜ç»†sheet
                        const detailSheetData = [['æ–‡ä»¶å', 'è¡Œå·', 'å‚æ•°', ...Array.from({length: groupData.data[0].length - 1}, (_, i) => `æ•°æ®${i+1}`)]];
                        
                        for (const file of configuredFiles) {
                            const fileConfig = group.fileConfigs[file.name];
                            if (!fileConfig) continue;

                            const data = allData[file.name];
                            if (!data || data.length === 0) continue;

                            const paramCol = fileConfig.paramCol;
                            const paramRowStart = fileConfig.paramRowStart || 1;
                            const paramRowEnd = fileConfig.paramRowEnd || (data.length - 1);
                            const dataCols = fileConfig.dataCols;
                            const dataRowStart = fileConfig.dataRowStart || 1;
                            const dataRowEnd = fileConfig.dataRowEnd || (data.length - 1);

                            const actualRowStart = Math.max(paramRowStart, dataRowStart);
                            const actualRowEnd = Math.min(paramRowEnd, dataRowEnd);

                            for (let row = actualRowStart; row <= actualRowEnd; row++) {
                                const paramCell = data[row][paramCol];
                                if (!paramCell || String(paramCell).trim() === '') continue;

                                const param = String(paramCell).trim();
                                const rowData = [file.name, row + 1, param];

                                for (const col of dataCols) {
                                    const cell = data[row][col];
                                    const value = cell && !isNaN(parseFloat(cell)) ? parseFloat(cell) : 0;
                                    rowData.push(value);
                                }

                                detailSheetData.push(rowData);
                            }
                        }

                        const detailWorksheet = XLSX.utils.aoa_to_sheet(detailSheetData);
                        XLSX.utils.book_append_sheet(workbook, detailWorksheet, 'è®¡ç®—æ˜ç»†');

                        // ç”ŸæˆBlob
                        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                        const blob = new Blob([wbout], { type: 'application/octet-stream' });

                        // å­˜å‚¨ç»“æœ
                        state.groupResults[groupName] = {
                            blob: blob,
                            workbook: workbook,
                            recordCount: groupData.data.length
                        };

                        log(`âœ“ åˆ†ç»„ "${groupName}" å¤„ç†å®Œæˆï¼Œ${groupData.data.length} æ¡è®°å½•`, 'success');
                    } else {
                        log(`âš  åˆ†ç»„ "${groupName}" æ— æ•°æ®`, 'warning');
                    }

                    completedGroups++;
                }

                showProgress(100);
                
                renderGroupDownloadList();
                
                log('æ‰€æœ‰åˆ†ç»„å¤„ç†å®Œæˆï¼', 'success');
                updateStatus('åˆ†ç»„åˆå¹¶å®Œæˆ', false);

            } catch (error) {
                log(`åˆ†ç»„åˆå¹¶é”™è¯¯: ${error.message}`, 'error');
                updateStatus('å¤„ç†å¤±è´¥', false);
            } finally {
                setTimeout(() => {
                    state.isProcessing = false;
                    elements.startManualMergeBtn.disabled = false;
                    hideProgress();
                }, 1000);
            }
        }

        function renderGroupDownloadList() {
            const groups = Object.keys(state.groupResults);
            
            if (groups.length === 0) {
                elements.groupDownloadList.innerHTML = `
                    <div class="empty-state">
                        æš‚æ— åˆ†ç»„ç»“æœï¼Œè¯·å…ˆè¿è¡Œåˆå¹¶
                    </div>
                `;
                elements.groupDownloadSection.classList.remove('active');
                return;
            }

            let html = '';
            groups.forEach(groupName => {
                const result = state.groupResults[groupName];
                html += `
                    <div class="group-download-item">
                        <div class="group-download-info">
                            <div class="group-name">${groupName}</div>
                            <div class="group-stats">è®°å½•æ•°: ${result.recordCount} | å¤§å°: ${formatFileSize(result.blob.size)}</div>
                        </div>
                        <div class="group-download-actions">
                            <button class="btn btn-success download-group-btn" data-group-name="${groupName}">
                                <span>ğŸ“¥</span> ä¸‹è½½ ${groupName}
                            </button>
                        </div>
                    </div>
                `;
            });

            elements.groupDownloadList.innerHTML = html;
            elements.groupDownloadSection.classList.add('active');
        }

        function downloadGroupResult(groupName) {
            const result = state.groupResults[groupName];
            if (!result || !result.blob) {
                log(`åˆ†ç»„ "${groupName}" çš„ç»“æœä¸å¯ç”¨`, 'error');
                return;
            }

            const fileName = `${groupName}_åˆå¹¶ç»“æœ.xlsx`;
            
            const url = URL.createObjectURL(result.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log(`å·²ä¸‹è½½åˆ†ç»„ç»“æœ: ${fileName}`, 'success');
        }

        // ==================== è‡ªåŠ¨æ¨¡å¼åŸæœ‰åŠŸèƒ½ ====================
        
        async function startMergeProcess() {
            if (state.files.length === 0) {
                log('è¯·å…ˆæ·»åŠ Excelæ–‡ä»¶', 'error');
                return;
            }
            
            if (state.isProcessing) return;
            
            state.isProcessing = true;
            elements.startMergeBtn.disabled = true;
            elements.downloadBtn.disabled = true;
            elements.addFilesBtn.disabled = true;
            elements.clearListBtn.disabled = true;
            elements.removeSelectedBtn.disabled = true;
            
            updateStatus('æ­£åœ¨å¤„ç†...', true);
            log('å¼€å§‹åˆå¹¶Excelæ–‡ä»¶...', 'info');
            showProgress(5);
            
            try {
                let progress = 5;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress > 90) progress = 90;
                    showProgress(progress);
                }, 200);
                
                const result = await mergeExcelFiles(state.files);
                
                clearInterval(progressInterval);
                showProgress(100);
                
                state.mergedWorkbook = result.workbook;
                state.mergedBlob = result.blob;
                
                log('åˆå¹¶å®Œæˆï¼', 'success');
                updateStatus('åˆå¹¶å®Œæˆ', false);
                elements.downloadBtn.disabled = false;
                
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
                updateStatus('å¤„ç†å¤±è´¥', false);
            } finally {
                setTimeout(() => {
                    state.isProcessing = false;
                    elements.startMergeBtn.disabled = false;
                    elements.addFilesBtn.disabled = false;
                    elements.clearListBtn.disabled = false;
                    elements.removeSelectedBtn.disabled = false;
                    hideProgress();
                }, 1000);
            }
        }

        async function mergeExcelFiles(files) {
            return new Promise(async (resolve, reject) => {
                try {
                    const startKeywords = [
                        "å¹´åˆ", "æœŸåˆ", "å¹´åˆä½™é¢", "æœŸåˆä½™é¢", "æœŸåˆæ•°", "å¹´åˆæ•°",
                        "å¹´åˆé‡‘é¢", "æœŸåˆé‡‘é¢", "å¹´åˆå€¼", "æœŸåˆå€¼", "ä¸Šå¹´å¹´æœ«", "ä¸ŠæœŸæœŸåˆ"
                    ];
                    const endKeywords = [
                        "æœŸæœ«", "å¹´æœ«", "æœŸæœ«ä½™é¢", "å¹´æœ«ä½™é¢", "æœŸæœ«æ•°", "å¹´æœ«æ•°",
                        "æœŸæœ«é‡‘é¢", "å¹´æœ«é‡‘é¢", "æœŸæœ«å€¼", "å¹´æœ«å€¼", "æœ¬æœŸæœŸæœ«", "æœ¬å¹´æœŸæœ«", "æœ¬æœŸ"
                    ];

                    const detailList = [];
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        log(`å¤„ç†æ–‡ä»¶ (${i+1}/${files.length}): ${file.name}`, 'info');
                        
                        try {
                            const data = await readFileAsArrayBuffer(file);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            const range = XLSX.utils.decode_range(worksheet['!ref']);
                            const lastRow = Math.min(range.e.r + 1, 100);
                            
                            let assetHeaderRow = null, assetCol = null;
                            let liabHeaderRow = null, liabCol = null;
                            
                            for (let r = 0; r < Math.min(5, lastRow); r++) {
                                for (let c = range.s.c; c <= range.e.c; c++) {
                                    const cellAddress = XLSX.utils.encode_cell({r, c});
                                    const cell = worksheet[cellAddress];
                                    if (!cell || !cell.v) continue;
                                    
                                    const cleanTxt = String(cell.v).replace(/[\sã€€]+/g, '');
                                    
                                    if (!assetHeaderRow && cleanTxt === "èµ„äº§") {
                                        assetHeaderRow = r;
                                        assetCol = c;
                                    }
                                    
                                    if (!liabHeaderRow && (
                                        cleanTxt.includes("è´Ÿå€º") && (cleanTxt.includes("è‚¡ä¸œæƒç›Š") || cleanTxt.includes("æ‰€æœ‰è€…æƒç›Š")) ||
                                        cleanTxt.includes("è´Ÿå€ºåŠæ‰€æœ‰è€…æƒç›Š") ||
                                        cleanTxt.includes("è´Ÿå€ºå’Œè‚¡ä¸œæƒç›Š") ||
                                        (cleanTxt.includes("æ‰€æœ‰è€…æƒç›Š") && cleanTxt.includes("è´Ÿå€º"))
                                    )) {
                                        liabHeaderRow = r;
                                        liabCol = c;
                                    }
                                }
                            }
                            
                            if (!assetCol && !liabCol) {
                                log(`  è­¦å‘Š: åœ¨ ${file.name} ä¸­æœªæ‰¾åˆ°'èµ„äº§'æˆ–'è´Ÿå€º'æ ‡é¢˜`, 'warning');
                                continue;
                            }
                            
                            function isSerialColumn(col, startRow, endRow) {
                                let intCount = 0;
                                let totalCount = 0;
                                for (let r = startRow; r <= endRow; r++) {
                                    const cellAddress = XLSX.utils.encode_cell({r, c: col});
                                    const cell = worksheet[cellAddress];
                                    if (!cell || !cell.v) continue;
                                    totalCount++;
                                    const val = String(cell.v).trim();
                                    if (/^\d+$/.test(val)) {
                                        const num = parseInt(val);
                                        if (num >= 1 && num <= 30) intCount++;
                                    }
                                }
                                return totalCount > 0 && (intCount / totalCount) > 0.6;
                            }
                            
                            function isAmountColumn(col, startRow, endRow) {
                                let numCount = 0;
                                let totalCount = 0;
                                for (let r = startRow; r <= endRow; r++) {
                                    const cellAddress = XLSX.utils.encode_cell({r, c: col});
                                    const cell = worksheet[cellAddress];
                                    if (!cell || !cell.v) continue;
                                    totalCount++;
                                    const val = String(cell.v).trim();
                                    if (/^-?\d*\.?\d*$/.test(val)) {
                                        const num = parseFloat(val);
                                        if (num < -100 || num > 100 || num !== Math.floor(num)) {
                                            numCount++;
                                        }
                                    }
                                }
                                return totalCount > 0 && (numCount / totalCount) > 0.4;
                            }
                            
                            const assetDataRow = assetHeaderRow !== null ? assetHeaderRow + 1 : 0;
                            const liabDataRow = liabHeaderRow !== null ? liabHeaderRow + 1 : 0;
                            const dataStartRow = Math.max(assetDataRow, liabDataRow);
                            const scanEndRow = Math.min(dataStartRow + 15, lastRow);
                            
                            // è¯†åˆ«èµ„äº§åŒºåˆ—
                            let assetStartCol = null, assetEndCol = null;
                            if (assetCol !== null) {
                                for (let c = assetCol + 1; c <= range.e.c; c++) {
                                    const cellAddress = XLSX.utils.encode_cell({r: assetHeaderRow, c});
                                    const cell = worksheet[cellAddress];
                                    const hdr = cell ? String(cell.v).trim() : '';
                                    
                                    if (!assetStartCol) {
                                        for (const kw of startKeywords) {
                                            if (hdr.includes(kw)) {
                                                assetStartCol = c;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (!assetEndCol) {
                                        for (const kw of endKeywords) {
                                            if (hdr.includes(kw)) {
                                                assetEndCol = c;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (assetStartCol && assetEndCol) break;
                                }
                                
                                if (!assetStartCol || !assetEndCol) {
                                    const amountCols = [];
                                    for (let c = assetCol + 1; c <= Math.min(assetCol + 10, range.e.c); c++) {
                                        if (isSerialColumn(c, dataStartRow, scanEndRow)) continue;
                                        if (isAmountColumn(c, dataStartRow, scanEndRow)) {
                                            amountCols.push(c);
                                            if (amountCols.length >= 2) break;
                                        }
                                    }
                                    if (amountCols.length >= 2) {
                                        assetStartCol = amountCols[0];
                                        assetEndCol = amountCols[1];
                                    } else if (amountCols.length === 1) {
                                        assetStartCol = null;
                                        assetEndCol = amountCols[0];
                                    }
                                }
                            }
                            
                            // è¯†åˆ«è´Ÿå€ºåŒºåˆ—
                            let liabStartCol = null, liabEndCol = null;
                            if (liabCol !== null) {
                                for (let c = liabCol + 1; c <= range.e.c; c++) {
                                    const cellAddress = XLSX.utils.encode_cell({r: liabHeaderRow, c});
                                    const cell = worksheet[cellAddress];
                                    const hdr = cell ? String(cell.v).trim() : '';
                                    
                                    if (!liabStartCol) {
                                        for (const kw of startKeywords) {
                                            if (hdr.includes(kw)) {
                                                liabStartCol = c;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (!liabEndCol) {
                                        for (const kw of endKeywords) {
                                            if (hdr.includes(kw)) {
                                                liabEndCol = c;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (liabStartCol && liabEndCol) break;
                                }
                                
                                if (!liabStartCol || !liabEndCol) {
                                    const amountCols = [];
                                    for (let c = liabCol + 1; c <= Math.min(liabCol + 10, range.e.c); c++) {
                                        if (isSerialColumn(c, dataStartRow, scanEndRow)) continue;
                                        if (isAmountColumn(c, dataStartRow, scanEndRow)) {
                                            amountCols.push(c);
                                            if (amountCols.length >= 2) break;
                                        }
                                    }
                                    if (amountCols.length >= 2) {
                                        liabStartCol = amountCols[0];
                                        liabEndCol = amountCols[1];
                                    } else if (amountCols.length === 1) {
                                        liabStartCol = null;
                                        liabEndCol = amountCols[0];
                                    }
                                }
                            }
                            
                            // æå–æ•°æ®
                            const seenInThisFile = {};
                            let row = dataStartRow;
                            
                            while (row < lastRow) {
                                // èµ„äº§æ•°æ®
                                if (assetCol !== null && assetStartCol !== null && assetEndCol !== null) {
                                    const itemCell = worksheet[XLSX.utils.encode_cell({r: row, c: assetCol})];
                                    const item = itemCell ? String(itemCell.v).trim() : '';
                                    
                                    if (item) {
                                        const startCell = worksheet[XLSX.utils.encode_cell({r: row, c: assetStartCol})];
                                        const endCell = worksheet[XLSX.utils.encode_cell({r: row, c: assetEndCol})];
                                        
                                        const startVal = startCell && !isNaN(parseFloat(startCell.v)) ? parseFloat(startCell.v) : 0;
                                        const endVal = endCell && !isNaN(parseFloat(endCell.v)) ? parseFloat(endCell.v) : 0;
                                        
                                        const key = `èµ„äº§||${item}||${startVal}||${endVal}`;
                                        if (!seenInThisFile[key]) {
                                            seenInThisFile[key] = true;
                                            detailList.push({
                                                Category: 'èµ„äº§',
                                                Item: item,
                                                File: file.name,
                                                Start: startVal,
                                                End: endVal
                                            });
                                        }
                                    }
                                }
                                
                                // è´Ÿå€ºæ•°æ®
                                if (liabCol !== null && liabStartCol !== null && liabEndCol !== null) {
                                    const itemCell = worksheet[XLSX.utils.encode_cell({r: row, c: liabCol})];
                                    const item = itemCell ? String(itemCell.v).trim() : '';
                                    
                                    if (item) {
                                        const startCell = worksheet[XLSX.utils.encode_cell({r: row, c: liabStartCol})];
                                        const endCell = worksheet[XLSX.utils.encode_cell({r: row, c: liabEndCol})];
                                        
                                        const startVal = startCell && !isNaN(parseFloat(startCell.v)) ? parseFloat(startCell.v) : 0;
                                        const endVal = endCell && !isNaN(parseFloat(endCell.v)) ? parseFloat(endCell.v) : 0;
                                        
                                        const key = `è´Ÿå€ºåŠæ‰€æœ‰è€…æƒç›Š||${item}||${startVal}||${endVal}`;
                                        if (!seenInThisFile[key]) {
                                            seenInThisFile[key] = true;
                                            detailList.push({
                                                Category: 'è´Ÿå€ºåŠæ‰€æœ‰è€…æƒç›Š',
                                                Item: item,
                                                File: file.name,
                                                Start: startVal,
                                                End: endVal
                                            });
                                        }
                                    }
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ•°æ®ç»“å°¾
                                if (row > 30) {
                                    const assetEmpty = assetCol !== null ? 
                                        !worksheet[XLSX.utils.encode_cell({r: row, c: assetCol})] || 
                                        String(worksheet[XLSX.utils.encode_cell({r: row, c: assetCol})].v).trim() === '' : true;
                                    const liabEmpty = liabCol !== null ? 
                                        !worksheet[XLSX.utils.encode_cell({r: row, c: liabCol})] || 
                                        String(worksheet[XLSX.utils.encode_cell({r: row, c: liabCol})].v).trim() === '' : true;
                                    
                                    if (assetEmpty && liabEmpty) break;
                                }
                                row++;
                            }
                            
                        } catch (err) {
                            log(`  å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™: ${err.message}`, 'error');
                        }
                    }
                    
                    if (detailList.length === 0) {
                        throw new Error('æœªè¯»å–åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼');
                    }
                    
                    log(`ä» ${files.length} ä¸ªæ–‡ä»¶ä¸­æå–åˆ° ${detailList.length} æ¡æ˜ç»†è®°å½•`, 'success');
                    log('å¼€å§‹ç”Ÿæˆåˆå¹¶ç»“æœ...', 'info');
                    
                    // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè®¡ç®—æ˜ç»†è¡¨
                    const detailSheetData = [];
                    detailSheetData.push(['ç±»åˆ«', 'é¡¹ç›®', 'æ–‡ä»¶å', 'å¹´åˆæ•°', 'æœŸæœ«æ•°']);
                    
                    detailList.forEach(rec => {
                        detailSheetData.push([
                            rec.Category,
                            rec.Item,
                            rec.File,
                            rec.Start,
                            rec.End
                        ]);
                    });
                    
                    const detailWorksheet = XLSX.utils.aoa_to_sheet(detailSheetData);
                    
                    // ç¬¬äºŒæ­¥ï¼šæ±‡æ€»æ•°æ®
                    const assetMap = new Map();
                    const liabMap = new Map();
                    const assetOrder = [];
                    const liabOrder = [];
                    
                    const groupedData = {};
                    detailList.forEach(rec => {
                        const key = `${rec.Category}||${rec.Item}`;
                        if (!groupedData[key]) {
                            groupedData[key] = [];
                        }
                        groupedData[key].push(rec);
                    });
                    
                    for (const [key, group] of Object.entries(groupedData)) {
                        const [category, item] = key.split('||');
                        const totalStart = group.reduce((sum, rec) => sum + rec.Start, 0);
                        const totalEnd = group.reduce((sum, rec) => sum + rec.End, 0);
                        
                        log(`æ±‡æ€»: ${category} - ${item} | å¹´åˆ: ${totalStart} | æœŸæœ«: ${totalEnd}`, 'info');
                        
                        if (category === 'èµ„äº§') {
                            assetMap.set(item, [totalStart, totalEnd]);
                            if (!assetOrder.includes(item)) {
                                assetOrder.push(item);
                            }
                        } else if (category === 'è´Ÿå€ºåŠæ‰€æœ‰è€…æƒç›Š') {
                            liabMap.set(item, [totalStart, totalEnd]);
                            if (!liabOrder.includes(item)) {
                                liabOrder.push(item);
                            }
                        }
                    }
                    
                    // ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºåˆå¹¶ç»“æœè¡¨
                    const resultSheetData = [];
                    resultSheetData.push([
                        'èµ„äº§', 'å¹´åˆæ•°', 'æœŸæœ«æ•°',
                        'è´Ÿå€ºåŠæ‰€æœ‰è€…æƒç›Š', 'å¹´åˆæ•°', 'æœŸæœ«æ•°'
                    ]);
                    
                    const maxRows = Math.max(assetOrder.length, liabOrder.length);
                    log(`èµ„äº§é¡¹ç›®æ•°: ${assetOrder.length}, è´Ÿå€ºé¡¹ç›®æ•°: ${liabOrder.length}`, 'info');
                    
                    for (let i = 0; i < maxRows; i++) {
                        const row = [];
                        
                        // èµ„äº§åˆ—
                        if (i < assetOrder.length) {
                            const item = assetOrder[i];
                            const vals = assetMap.get(item);
                            row.push(item, vals[0], vals[1]);
                        } else {
                            row.push('', '', '');
                        }
                        
                        // è´Ÿå€ºåˆ—
                        if (i < liabOrder.length) {
                            const item = liabOrder[i];
                            const vals = liabMap.get(item);
                            row.push(item, vals[0], vals[1]);
                        } else {
                            row.push('', '', '');
                        }
                        
                        resultSheetData.push(row);
                    }
                    
                    const resultWorksheet = XLSX.utils.aoa_to_sheet(resultSheetData);
                    
                    const mergedWorkbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(mergedWorkbook, resultWorksheet, 'åˆå¹¶ç»“æœ');
                    XLSX.utils.book_append_sheet(mergedWorkbook, detailWorksheet, 'è®¡ç®—æ˜ç»†');
                    
                    const wbout = XLSX.write(mergedWorkbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/octet-stream' });
                    
                    log('åˆå¹¶å®Œæˆï¼å‡†å¤‡ä¸‹è½½', 'success');
                    
                    resolve({
                        workbook: mergedWorkbook,
                        blob: blob
                    });
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        function downloadMergedFile() {
            if (!state.mergedBlob) {
                log('æ²¡æœ‰å¯ç”¨çš„åˆå¹¶ç»“æœ', 'error');
                return;
            }
            
            const fileName = elements.outputName.value.trim() || 'åˆå¹¶ç»“æœ.xlsx';
            
            const url = URL.createObjectURL(state.mergedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log(`å·²ä¸‹è½½æ–‡ä»¶: ${fileName}`, 'success');
        }

        // ==================== åº”ç”¨åˆå§‹åŒ– ====================
        
        function initApp() {
            log('Excelåˆå¹¶å·¥å…·å·²å°±ç»ª', 'info');
            log('æç¤ºï¼šæ‚¨å¯ä»¥é€‰æ‹©è‡ªåŠ¨æ¨¡å¼æˆ–æ‰‹åŠ¨æ¨¡å¼è¿›è¡Œæ–‡ä»¶åˆå¹¶', 'info');
            
            // æ£€æŸ¥HandsontableåŠ è½½çŠ¶æ€
            if (!checkHandsontableLoaded()) {
                log('ğŸ’¡ æç¤ºï¼šå¦‚æœæ— æ³•åŠ è½½è¡¨æ ¼é¢„è§ˆï¼Œå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥æ¨¡å¼é…ç½®åˆ—å·', 'info');
            }
            
            updateStatus('å°±ç»ª');
            initEventListeners();
        }

        // å¯åŠ¨åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>